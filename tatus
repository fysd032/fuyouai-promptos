[1mdiff --git a/app/api/generate/route.ts b/app/api/generate/route.ts[m
[1mindex e5c740c..964ac96 100644[m
[1m--- a/app/api/generate/route.ts[m
[1m+++ b/app/api/generate/route.ts[m
[36m@@ -1,32 +1,83 @@[m
[31m-export async function POST(req: Request) {[m
[31m-  try {[m
[31m-    console.log('[generate] start');[m
[32m+[m[32m// app/api/generate/route.ts  (vercel åç«¯ / nextjs)[m
[32m+[m
[32m+[m[32mimport { NextResponse } from "next/server";[m
 [m
[31m-    console.log('[generate] WORKER_URL =', process.env.WORKER_URL);[m[m
 [m
[31m-    const res = await fetch(`${process.env.WORKER_URL}/run`, {[m
[31m-      method: 'POST',[m
[31m-      headers: { 'Content-Type': 'application/json' },[m
[31m-      body: JSON.stringify(await req.json()),[m
[31m-    });[m
[32m+[m[32mconst worker_url = process.env.WORKER_URL!;[m
[32m+[m[32mconst worker_token = process.env.WORKER_TOKEN!;[m
 [m
[31m-    console.log('[generate] worker status:', res.status);[m
[32m+[m[32m// å¦‚æœä½ è¦æ”¯æŒ frontModuleId/variantIdï¼Œå°±éœ€è¦èƒ½æ‹¿åˆ° mapping æ•°æ®ï¼š[m
[32m+[m[32m// æ–¹å¼1ï¼šç›´æ¥ import ä½ çš„ module_mapping.v2.jsonï¼ˆä½  registry route ä¹Ÿæ˜¯è¿™ä¹ˆ import çš„ï¼‰[m
[32m+[m[32mimport mapping from "@/module_mapping.v2.json";[m
 [m
[31m-    const text = await res.text();[m
[31m-    console.log('[generate] worker response text:', text);[m
[32m+[m[32mfunction find_prompt_key_by_mapping(frontModuleId: string, variantId: string): string | null {[m
[32m+[m[32m  const fm = (mapping as any[]).find((x) => x.frontModuleId === frontModuleId);[m
[32m+[m[32m  if (!fm) return null;[m
[32m+[m[32m  const v = (fm.variants || []).find((x: any) => x.variantId === variantId);[m
[32m+[m[32m  if (!v) return null;[m
[32m+[m[32m  const bm = (v.backendModules || [])[0];[m
[32m+[m[32m  return bm?.promptKey || bm?.moduleId || null;[m
[32m+[m[32m}[m
 [m
[31m-    if (!res.ok) {[m
[31m-      throw new Error(`Worker responded with ${res.status}: ${text}`);[m
[32m+[m[32mexport async function POST(req: Request) {[m
[32m+[m[32m  const body = await req.json().catch(() => ({}));[m
[32m+[m
[32m+[m[32m  // âœ… å…¼å®¹ä¸¤ç§è¾“å…¥[m
[32m+[m[32m  let { promptKey, userInput, engineType = "deepseek" } = body || {};[m
[32m+[m
[32m+[m[32m  // mapping æ¨¡å¼ï¼šç”¨ frontModuleId + variantId åæŸ¥ promptKey[m
[32m+[m[32m  if (!promptKey) {[m
[32m+[m[32m    const { frontModuleId, variantId } = body || {};[m
[32m+[m[32m    if (frontModuleId && variantId) {[m
[32m+[m[32m      promptKey = find_prompt_key_by_mapping(frontModuleId, variantId);[m
     }[m
[32m+[m[32m  }[m
 [m
[31m-    return new Response(text, { status: 200 });[m
[31m-  } catch (err) {[m
[31m-    console.error('[generate] ERROR:', err);[m
[31m-    return new Response([m
[31m-      JSON.stringify({ error: String(err) }),[m
[31m-      { status: 500 }[m
[32m+[m[32m  if (!promptKey || !userInput) {[m
[32m+[m[32m    return NextResponse.json([m
[32m+[m[32m      { ok: false, error: "missing promptKey or (frontModuleId+variantId) or userInput" },[m
[32m+[m[32m      { status: 400 }[m
     );[m
   }[m
[32m+[m
[32m+[m[32m  // 1) å‘ worker åˆ›å»ºä»»åŠ¡[m
[32m+[m[32m  const r = await fetch(`${worker_url}/run`, {[m
[32m+[m[32m    method: "POST",[m
[32m+[m[32m    headers: {[m
[32m+[m[32m      "Content-Type": "application/json",[m
[32m+[m[32m      "x-worker-token": worker_token,[m
[32m+[m[32m    },[m
[32m+[m[32m    body: JSON.stringify({ promptKey, userInput, engineType }),[m
[32m+[m[32m  });[m
[32m+[m
[32m+[m[32m  if (!r.ok) {[m
[32m+[m[32m    const t = await r.text();[m
[32m+[m[32m    return NextResponse.json({ ok: false, error: `worker failed: ${t}` }, { status: 500 });[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  const { jobId } = await r.json();[m
[32m+[m
[32m+[m[32m  // 2) ç«‹åˆ»è¿”å›ç»™å‰ç«¯[m
