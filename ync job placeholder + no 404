[1mdiff --git a/app/api/generate/route.ts b/app/api/generate/route.ts[m
[1mindex 964ac96..ac4797e 100644[m
[1m--- a/app/api/generate/route.ts[m
[1m+++ b/app/api/generate/route.ts[m
[36m@@ -3,13 +3,15 @@[m
 import { NextResponse } from "next/server";[m
 [m
[32m+[m[32mexport const runtime = "nodejs";[m
[32m+[m[32mexport const dynamic = "force-dynamic";[m
[32m+[m
[m
 [m
[31m-const worker_url = process.env.WORKER_URL!;[m
[31m-const worker_token = process.env.WORKER_TOKEN!;[m
[32m+[m[32mconst worker_url = (process.env.WORKER_URL || "").replace(/\/$/, "");[m
[32m+[m[32mconst worker_token = process.env.WORKER_TOKEN || "";[m
 [m
 // å¦‚æœä½ è¦æ”¯æŒ frontModuleId/variantIdï¼Œå°±éœ€è¦èƒ½æ‹¿åˆ° mapping æ•°æ®ï¼š[m
[31m-// æ–¹å¼1ï¼šç›´æ¥ import ä½ çš„ module_mapping.v2.jsonï¼ˆä½  registry route ä¹Ÿæ˜¯è¿™ä¹ˆ import çš„ï¼‰[m
 import mapping from "@/module_mapping.v2.json";[m
 [m
 function find_prompt_key_by_mapping(frontModuleId: string, variantId: string): string | null {[m
[36m@@ -42,6 +44,14 @@[m [mexport async function POST(req: Request) {[m
     );[m
   }[m
 [m
[32m+[m[32m  // âœ… ç¯å¢ƒå˜é‡ç¼ºå¤±ç›´æ¥æŠ¥é”™ï¼ˆé¿å…æ‚„æ‚„ 500ï¼‰[m
[32m+[m[32m  if (!worker_url) {[m
[32m+[m[32m    return NextResponse.json({ ok: false, error: "Missing WORKER_URL" }, { status: 500 });[m
[32m+[m[32m  }[m
[32m+[m[32m  if (!worker_token) {[m
[32m+[m[32m    return NextResponse.json({ ok: false, error: "Missing WORKER_TOKEN" }, { status: 500 });[m
[32m+[m[32m  }[m
[32m+[m
   // 1) å‘ worker åˆ›å»ºä»»åŠ¡[m
   const r = await fetch(`${worker_url}/run`, {[m
     method: "POST",[m
[36m@@ -52,14 +62,51 @@[m [mexport async function POST(req: Request) {[m
     body: JSON.stringify({ promptKey, userInput, engineType }),[m
   });[m
 [m
[32m+[m[32m  const workerText = await r.text().catch(() => "");[m
[32m+[m
   if (!r.ok) {[m
[31m-    const t = await r.text();[m
[31m-    return NextResponse.json({ ok: false, error: `worker failed: ${t}` }, { status: 500 });[m
[32m+[m[32m    return NextResponse.json([m
[32m+[m[32m      { ok: false, error: `worker failed`, status: r.status, workerText },[m
[32m+[m[32m      { status: 500 }[m
[32m+[m[32m    );[m
   }[m
 [m
[31m-  const { jobId } = await r.json();[m
[32m+[m[32m  let parsed: any = {};[m
[32m+[m[32m  try {[m
[32m+[m[32m    parsed = JSON.parse(workerText);[m
[32m+[m[32m  } catch {[m
[32m+[m[32m    parsed = {};[m
[32m+[m[32m  }[m
 [m
[31m-  // 2) ç«‹åˆ»è¿”å›ç»™å‰ç«¯[m
[32m+[m[32m  const jobId = parsed?.jobId;[m
[32m+[m
[32m+[m[32m  if (!jobId) {[m
[32m+[m[32m    return NextResponse.json([m
[32m+[m[32m      { ok: false, error: "worker did not return jobId", workerText },[m
[32m+[m[32m      { status: 500 }[m
[32m+[m[32m    );[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  // âœ… 2) å…³é”®ï¼šå…ˆå†™ä¸€æ¡å ä½è®°å½•ï¼Œé¿å… GET ç«‹åˆ» not found[m
[32m+[m[32m  // ï¼ˆå³ä¾¿ worker æ²¡ Redisï¼Œå‰ç«¯ä¹Ÿä¸ä¼šå› ä¸º 404 å´©æ‰ï¼‰[m
[32m+[m[32m  const ttlSec = 60 * 30;[m
[32m+[m[32m  await redis[m
[32m+[m[32m    .set([m
[32m+[m[32m      `job:${jobId}`,[m
[32m+[m[32m      {[m
[32m+[m[32m        status: "queued",[m
[32m+[m[32m        ok: true,[m
[32m+[m[32m        promptKey,[m
[32m+[m[32m        engineType,[m
[32m+[m[32m        createdAt: Date.now(),[m
[32m+[m[32m        text: "æ­£åœ¨ç”Ÿæˆï¼Œè¯·è€å¿ƒç­‰å¾…â€¦",[m
[32m+[m[32m        modelOutput: "æ­£åœ¨ç”Ÿæˆï¼Œè¯·è€å¿ƒç­‰å¾…â€¦",[m
[32m+[m[32m      },[m
[32m+[m[32m      { ex: ttlSec }[m
[32m+[m[32m    )[m
[32m+[m[32m    .catch(() => {});[m
[32m+[m
[32m+[m[32m  // 3) ç«‹åˆ»è¿”å›ç»™å‰ç«¯[m
   return NextResponse.json({[m
     ok: true,[m
     degraded: true,[m
[36m@@ -76,8 +123,20 @@[m [mexport async function GET(req: Request) {[m
   const jobId = searchParams.get("jobId");[m
   if (!jobId) return NextResponse.json({ ok: false, error: "missing jobId" }, { status: 400 });[m
 [m
[31m-  const data = await redis.get(`job:${jobId}`);[m
[31m-  if (!data) return NextResponse.json({ ok: false, error: "not found" }, { status: 404 });[m
[32m+[m[32m  const data = await redis.get(`job:${jobId}`).catch(() => null);[m
[32m+[m
[32m+[m[32m  // âœ… å…³é”®æ”¹åŠ¨ï¼šä¸è¦å†è¿”å› 404 not found[m
[32m+[m[32m  // æŸ¥ä¸åˆ°å°±å½“ä½œ still runningï¼ˆå‰ç«¯å°±ä¸ä¼šæŠ¥é”™ï¼‰[m
[32m+[m[32m  if (!data) {[m
[32m+[m[32m    return NextResponse.json({[m
[32m+[m[32m      ok: true,[m
[32m+[m[32m      jobId,[m
[32m+[m[32m      status: "running",[m
[32m+[m[32m      text: "æ­£åœ¨ç”Ÿæˆï¼Œè¯·è€å¿ƒç­‰å¾…â€¦",[m
[32m+[m[32m      modelOutput: "æ­£åœ¨ç”Ÿæˆï¼Œè¯·è€å¿ƒç­‰å¾…â€¦",[m
[32m+[m[32m      hint: "No redis record yet. If it never becomes done, ensure worker writes job status to Redis.",[m
[32m+[m[32m    });[m
[32m+[m[32m  }[m
 [m
   return NextResponse.json({ ok: true, ...(data as any) });[m
[31m-}[m
\ No newline at end of file[m
[32m+[m[32m}[m
